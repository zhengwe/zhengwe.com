"use strict";(self.webpackChunkzhengwe=self.webpackChunkzhengwe||[]).push([[894],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>u});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),p=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(s.Provider,{value:n},e.children)},_="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),_=p(t),d=a,u=_["".concat(s,".").concat(d)]||_[d]||m[d]||i;return t?r.createElement(u,o(o({ref:n},c),{},{components:t})):r.createElement(u,o({ref:n},c))}));function u(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[_]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=t[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},7073:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=t(7462),a=(t(7294),t(3905));const i={slug:"nginx",title:"Nginx \u5e38\u7528\u914d\u7f6e",authors:["innocence"],tags:["linux"]},o=void 0,l={permalink:"/nginx",source:"@site/blog/2023-12-10/index.md",title:"Nginx \u5e38\u7528\u914d\u7f6e",description:"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eIP\u3001\u57df\u540d\u3001\u534f\u8bae\u3001\u7aef\u53e3",date:"2023-12-10T00:00:00.000Z",formattedDate:"December 10, 2023",tags:[{label:"linux",permalink:"/tags/linux"}],readingTime:4.95,hasTruncateMarker:!1,authors:[{name:"Innocence",title:"zheng wei",url:"https://github.com/zhengwe.com",imageURL:"https://zhengwe.com/img/logo.svg",key:"innocence"}],frontMatter:{slug:"nginx",title:"Nginx \u5e38\u7528\u914d\u7f6e",authors:["innocence"],tags:["linux"]},nextItem:{title:"Istio \u8fd4\u56de 426 \u72b6\u6001\u7801",permalink:"/istio"}},s={authorsImageUrls:[void 0]},p=[{value:"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eIP\u3001\u57df\u540d\u3001\u534f\u8bae\u3001\u7aef\u53e3",id:"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eip\u57df\u540d\u534f\u8bae\u7aef\u53e3",level:3},{value:"\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e",id:"\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e",level:3},{value:"\u9759\u6001\u8d44\u6e90\u7f13\u5b58",id:"\u9759\u6001\u8d44\u6e90\u7f13\u5b58",level:3},{value:"\u52a8\u6001\u9ed1\u540d\u5355",id:"\u52a8\u6001\u9ed1\u540d\u5355",level:3},{value:"nginx \u7684\u8f6c\u53d1\u89c4\u5219",id:"nginx-\u7684\u8f6c\u53d1\u89c4\u5219",level:3},{value:"nginx.conf \u914d\u7f6e",id:"nginxconf-\u914d\u7f6e",level:3},{value:"stream \u914d\u7f6e",id:"stream-\u914d\u7f6e",level:3},{value:"server \u914d\u7f6e",id:"server-\u914d\u7f6e",level:3}],c={toc:p},_="wrapper";function m(e){let{components:n,...t}=e;return(0,a.kt)(_,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h3",{id:"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eip\u57df\u540d\u534f\u8bae\u7aef\u53e3"},"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eIP\u3001\u57df\u540d\u3001\u534f\u8bae\u3001\u7aef\u53e3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Host")," \u5305\u542b\u5ba2\u6237\u7aef\u771f\u5b9e\u7684\u57df\u540d\u548c\u7aef\u53e3\u53f7\uff1b"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"X-Forwarded-Proto")," \u8868\u793a\u5ba2\u6237\u7aef\u771f\u5b9e\u7684\u534f\u8bae\uff1b"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"X-Real-IP")," \u8868\u793a\u5ba2\u6237\u7aef\u771f\u5b9e\u7684IP\uff1b"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"X-Forwarded-For")," \u548c ",(0,a.kt)("inlineCode",{parentName:"li"},"X-Real-IP")," \u7c7b\u4f3c\uff0c\u4f46\u5b83\u5728\u591a\u5c42\u4ee3\u7406\u65f6\u4f1a\u5305\u542b\u771f\u5b9e\u5ba2\u6237\u7aef\u53ca\u4e2d\u95f4\u6bcf\u4e2a\u4ee3\u7406\u670d\u52a1\u5668\u7684IP\uff1b")),(0,a.kt)("h3",{id:"\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e"},"\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"fail_timeout"),"\u65f6\u95f4\u5185\u5931\u8d25\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"max_fails"),"\u6b21\u8bf7\u6c42\u540e\uff0c\u5c06\u8be5\u670d\u52a1\u5730\u5740\u5254\u9664\u6389\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"fail_tiemout"),"\u65f6\u95f4\u540e\u4f1a\u518d\u6b21\u5c06\u8be5\u670d\u52a1\u5668\u52a0\u5165\u5b58\u6d3b\u5217\u8868\uff0c\u8fdb\u884c\u91cd\u8bd5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"http {\n    upstream server_name {\n    server IP:Port weight=1 max_fails=2 fail_timeout=60s;\n    server IP:Port weight=2 max_fails=2 fail_timeout=60s;\n    }\n    server {\n        listen  80;\n        location / {\n            proxy_pass http://server_name;\n        }\n    }\n}\n")),(0,a.kt)("h3",{id:"\u9759\u6001\u8d44\u6e90\u7f13\u5b58"},"\u9759\u6001\u8d44\u6e90\u7f13\u5b58"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"location ~* .(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ {\n    expires      3d;\n    add_header Static Nginx-Proxy;\n}\n")),(0,a.kt)("h3",{id:"\u52a8\u6001\u9ed1\u540d\u5355"},"\u52a8\u6001\u9ed1\u540d\u5355"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u4e00\u822c\u914d\u7f6e")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"location / {\n    deny  192.168.1.1;\n    deny  192.168.1.0/24;\n    allow 10.0.0.0/16;\n    allow 2001:0db8::/32;\n    deny  all;\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Lua+Redis\u52a8\u6001\u9ed1\u540d\u5355(OpenResty)")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'yum install yum-utils\nyum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo\nyum install openresty\nyum install openresty-resty\nyum --disablerepo="*" --enablerepo="openresty" list available\nservice openresty start\n')),(0,a.kt)("p",null,"\u914d\u7f6e(/usr/local/openresty/nginx/conf/nginx.conf)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"lua_shared_dict ip_blacklist 1m;\n\nserver {\n    listen  80;\n\n    location / {\n        access_by_lua_file lua/ip_blacklist.lua;\n        proxy_pass http://server_name;\n    }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"ip_blacklist.lua")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'local redis_host    = "192.168.1.100"\nlocal redis_port    = 6379\nlocal redis_pwd     = 123456\nlocal redis_db = 1\n\n-- connection timeout for redis in ms.\nlocal redis_connection_timeout = 100\n\n-- a set key for blacklist entries\nlocal redis_key     = "ip_blacklist"\n\n-- cache lookups for this many seconds\nlocal cache_ttl     = 60\n\n-- end configuration\n\nlocal ip                = ngx.var.remote_addr\nlocal ip_blacklist      = ngx.shared.ip_blacklist\nlocal last_update_time  = ip_blacklist:get("last_update_time");\n\n-- update ip_blacklist from Redis every cache_ttl seconds:\nif last_update_time == nil or last_update_time < ( ngx.now() - cache_ttl ) then\n\n  local redis = require "resty.redis";\n  local red = redis:new();\n\n  red:set_timeout(redis_connect_timeout);\n\n  local ok, err = red:connect(redis_host, redis_port);\n  if not ok then\n    ngx.log(ngx.ERR, "Redis connection error while connect: " .. err);\n  else\n    local ok, err = red:auth(redis_pwd)\n    if not ok then\n      ngx.log(ngx.ERR, "Redis password error while auth: " .. err);\n    else\n        local new_ip_blacklist, err = red:smembers(redis_key);\n        if err then\n            ngx.log(ngx.ERR, "Redis read error while retrieving ip_blacklist: " .. err);\n        else\n        ngx.log(ngx.ERR, "Get data success:" .. new_ip_blacklist)\n          -- replace the locally stored ip_blacklist with the updated values:\n            ip_blacklist:flush_all();\n          for index, banned_ip in ipairs(new_ip_blacklist) do\n            ip_blacklist:set(banned_ip, true);\n          end\n          -- update time\n          ip_blacklist:set("last_update_time", ngx.now());\n      end\n    end\n  end\nend\n\nif ip_blacklist:get(ip) then\n  ngx.log(ngx.ERR, "Banned IP detected and refused access: " .. ip);\n  return ngx.exit(ngx.HTTP_FORBIDDEN);\nend\n')),(0,a.kt)("h3",{id:"nginx-\u7684\u8f6c\u53d1\u89c4\u5219"},"nginx \u7684\u8f6c\u53d1\u89c4\u5219"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"location [=|~|~*|^~] /uri/ { ... }\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"=")," \u4e25\u683c\u5339\u914d\uff0c\u5982\u679c\u8bf7\u6c42\u5339\u914d\u8fd9\u4e2alocation\uff0c\u90a3\u4e48\u5c06\u505c\u6b62\u641c\u7d22\u7acb\u5373\u5904\u7406\u8bf7\u6c42"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"~")," \u533a\u5206\u5927\u5c0f\u5199\u5339\u914d\uff08\u53ef\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\uff09"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"~*")," \u4e0d\u533a\u5206\u5927\u5c0f\u5199\u5339\u914d\uff08\u53ef\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\uff09"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"!~")," \u533a\u5206\u5927\u5c0f\u5199\u4e0d\u5339\u914d"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"!~*")," \u4e0d\u533a\u5206\u5927\u5c0f\u5199\u4e0d\u5339\u914d"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"^~")," \u5982\u679c\u628a\u8fd9\u4e2a\u524d\u7f00\u7528\u4e8e\u4e00\u4e2a\u5e38\u89c4\u5b57\u7b26\u4e32,\u90a3\u4e48\u544a\u8bc9nginx\u5982\u679c\u8def\u5f84\u5339\u914d\u90a3\u4e48\u4e0d\u6d4b\u8bd5\u6b63\u5219\u8868\u8fbe\u5f0f")),(0,a.kt)("h3",{id:"nginxconf-\u914d\u7f6e"},"nginx.conf \u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'user  nginx;\nworker_processes  auto;\nworker_rlimit_nofile  65535;\n\npid        /var/run/nginx.pid;\nevents {\n    worker_connections  65535;\n    multi_accept on;\n    use epoll;\n}\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n    log_format  main  \'[$time_local] RemoteAddr:"$remote_addr" RemoteUser:"$remote_user" Host:"$host" \'\n                      \'RequestUil:"$request" HttpStatus:"$status" BodyBytesSent:"$body_bytes_sent" \'\n                      \'HttpReferer:"$http_referer" HttpUserAgent:"$http_user_agent" \'\n                      \'Http_X_ForwardedFor:"$http_x_forwarded_for" UpstreamResponseTime:"$upstream_response_time" \'\n                      \'UpstreamAddr:"$upstream_addr" RequestTime:"$request_time" --- $server_port\';\n    log_format  json  \'{\'\n        \'"RemoteAddr":"$remote_addr",\'\n        \'"RemoteUser":"$remote_user",\'\n        \'"TimeLocal":"$time_local",\'\n        \'"RequestUil":"$request",\'\n        \'"HttpHost":"$http_host"\'\n        \'"HttpStatus":"$status",\'\n        \'"BodyBytesSent":"$body_bytes_sent",\'\n        \'"HttpReferer":"$http_referer",\'\n        \'"HttpUserAgent":"$http_user_agent",\'\n        \'"Http_X_ForwardedFor":"$http_x_forwarded_for",\'\n        \'"SslProtocol":"$ssl_protocol"\'\n        \'"SslCipher":"$ssl_cipher"\'\n        \'"UpstreamResponseTime":"$upstream_response_time",\'\n        \'"UpstreamAddr":"$upstream_addr",\'\n        \'"RequestTime":"$request_time",\'\n    \'}\';\n\n    access_log /data/logs/access.log  main;\n    error_log  /data/logs/error.log error;\n\n    access_log                      off;\n    server_tokens                   off;\n    sendfile                         on;\n    tcp_nopush                       on;\n    tcp_nodelay                      on;\n    send_timeout                    300;\n    keepalive_timeout               300;\n    resolver_timeout                 60;\n    server_names_hash_max_size      512;\n    server_names_hash_bucket_size   128;\n\n    client_body_timeout             300;\n    client_header_timeout           300;\n    client_header_buffer_size      512k;\n    client_max_body_size           300m;\n    large_client_header_buffers  8  32k;\n    client_body_buffer_size        256k;\n\n    fastcgi_connect_timeout         300;\n    fastcgi_send_timeout            300;\n    fastcgi_read_timeout            300;\n    fastcgi_buffer_size            128k;\n    fastcgi_buffers          8     256k;\n    fastcgi_busy_buffers_size      256k;\n    fastcgi_temp_file_write_size   256k;\n    fastcgi_temp_path /tmp/ngx_fcgi_tmp;\n    fastcgi_cache_path /tmp/fcgi_cache_path levels=1:2 keys_zone=ngx_fcgi_cache:512m inactive=1d max_size=10g;\n\n    gzip  on;\n    gzip_http_version   1.1;\n    gzip_min_length      1k;\n    gzip_buffers 4      16k;\n    gzip_comp_level       9;\n    gzip_types text/plain application/json application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;\n    gzip_vary            on;\n    gzip_disable "MSIE [1-6]\\.";\n\n    proxy_http_version           1.1;\n    proxy_set_header Connection   "";\n    proxy_set_header     Host  $host;\n    proxy_connect_timeout        300;\n    proxy_read_timeout           300;\n    proxy_send_timeout           300;\n    proxy_buffering               on;\n    proxy_buffer_size           128k;\n    proxy_buffers            8  128k;\n    proxy_busy_buffers_size     256k;\n    proxy_temp_file_write_size  256k;\n    proxy_temp_path  /tmp/proxy_temp_path;\n    proxy_cache_path /tmp/proxy_cache_path levels=1:2 keys_zone=ngx_proxy_cache:512m inactive=1d max_size=10g;\n    include /etc/nginx/conf.d/*.conf;\n}\ninclude /etc/nginx/stream.d/*.conf;\n')),(0,a.kt)("h3",{id:"stream-\u914d\u7f6e"},"stream \u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"stream {\n    upstream server_name {\n        server  IP:Port;\n    }\n    server {\n        listen Port;\n        proxy_pass server_name;\n        proxy_connect_timeout 1h;\n        proxy_timeout 1h;\n    }\n}\n")),(0,a.kt)("h3",{id:"server-\u914d\u7f6e"},"server \u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'server {\n    listen   80;\n    listen   81;\n    server_name 127.0.0.1  example.com;\n    index  index.php index.html index.htm;\n    root /data/www;\n    charset utf-8;\n    access_log  /data/logs/example.com.log  main;\n\n    location / {\n        if (!-e $request_filename) {\n            rewrite ^/(.*) /index.php?$1 last;\n        }\n    }\n    location /xxx/ {\n        if ($arg_icpid = "4pd1mtsDhfe" ) {\n            proxy_pass http://127.0.0.1:38888/test$request_uri&tbid=aldIthSBg04;\n        }\n        proxy_pass http://127.0.0.1:9302;\n    }\n    location /xxx/ {\n        proxy_pass http://127.0.0.1:38888/;\n    }\n    location ~ \\.php$ {\n        fastcgi_param  REMOTE_ADDR $http_x_real_ip;\n        fastcgi_param LY_ADDRESS $remote_addr;\n        fastcgi_pass   unix:/dev/shm/php-cgi.sock;\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n        fastcgi_param  SERVERNAME     $hostname;\n        include        fastcgi_params;\n   }\n   location = /favicon.ico {\n        log_not_found off;\n        access_log off;\n   }\n   location = /robots.txt {\n        allow all;\n        log_not_found off;\n        access_log off;\n   }\n}\n\nserver {\n    listen   80;\n    listen   443 ssl;\n    server_name  example.com;\n    charset utf-8;\n    access_log  /data/logs/example.com.log main;\n\n    ssl_certificate   /etc/nginx/cert/example.com.pem;\n    ssl_certificate_key  /etc/nginx/cert/example.com.key;\n    ssl_session_timeout 5m;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n\n    location / {\n        proxy_pass http://127.0.0.1:38888;\n    }\n    location = /favicon.ico {\n        log_not_found off;\n        access_log off;\n    }\n    location = /robots.txt {\n        allow all;\n        log_not_found off;\n        access_log off;\n    }\n}\n')))}m.isMDXComponent=!0}}]);